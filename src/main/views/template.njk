{% extends "govuk/template.njk" %}
{% from "govuk/components/header/macro.njk" import govukHeader %}
{% from "govuk/components/footer/macro.njk" import govukFooter %}
{% from "govuk/components/phase-banner/macro.njk" import govukPhaseBanner %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "components/timeout-modal.njk" import timeoutModal with context %}

{% block head %}
  {% include "webpack/css.njk" %}
  <script>
    window.dataLayer = window.dataLayer || [];
  </script>
  <!-- Google Tag Manager -->
  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({'gtm.start': new Date().getTime(), event: 'gtm.js'});
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s),
        dl = l != 'dataLayer'
          ? '&l=' + l
          : '';
      j.async = true;
      j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
      f
        .parentNode
        .insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-M29HRGV');
  </script>
  <!-- End Google Tag Manager -->
  <meta name="format-detection" content="telephone=no">
{% endblock %}

{% block bodyStart %}
  <!-- Google Tag Manager (noscript) -->

  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-M29HRGV" height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>

  <!-- End Google Tag Manager (noscript) -->
{% endblock %}

{% set logInOrOut = {
  href: "/logout",
  text: signOut,
  active: false
}
if isLoggedIn %}

{% block header %}
  {% include "cookie-banner.njk" %}
  {{ govukHeader({
    containerClasses: "govuk-width-container",
    homepageUrl: "https://www.gov.uk",
    serviceName: serviceName,
    serviceUrl: "#",
    navigationClasses: 'govuk-header__navigation--end',
    navigation: [logInOrOut]
  }) }}
{% endblock %}

{% block pageTitle %}
  {{ title }}
  -
  {{ serviceName }}
  -
  {{ govUk }}
{% endblock %}

{% block beforeContent %}

  {% set smartSurveyPageInfo = currentUrl | replace("/", "") %}

  {% set phaseBarHtml = '<a class="govuk-link" href="' + phaseBanner.smartSurveyFeedbackUrl + smartSurveyPageInfo + '" target="_blank">' + phaseBanner.feedback + "</a> " + phaseBanner.additionalText %}

  {% if "lng=cy" in currentUrl %}
    {% set phaseBarText = "Lorem" %}
  {% else %}
    {% set phaseBarText = "beta" %}
  {% endif %}

  {% if welshEnabled %}
    {% set queryStringConcat = "" %}

    {% if "lng=" in currentUrl %}
      {% set currentUrl = currentUrl | replace("?lng=en", "") | replace("&lng=en", "") | replace("?lng=cy", "") | replace("&lng=cy", "") %}
    {% endif %}

    {% if "?" not in currentUrl %}
      {% set queryStringConcat = "?" %}
    {% else %}
      {% set queryStringConcat = "&" %}
    {% endif %}

    {% set languageFlag = "" %}
    {% if i18n.language == "en" %}
      {% set languageFlag = queryStringConcat + "lng=cy" %}
    {% else %}
      {% set languageFlag = queryStringConcat + "lng=en" %}
    {% endif %}

    {% set phaseBarHtml = phaseBarHtml + (phaseBanner.languageToggle | replace("{currentUrl}", currentUrl) | replace("{languageFlag}", languageFlag)) %}
  {% endif %}

  {{ timeoutModal() }}

  {{ govukPhaseBanner({
      tag: {
          text: phaseBarText
      },
      html: phaseBarHtml
  }) }}
{% endblock %}

{% block bodyEnd %}
  {# Run JavaScript at end of the <body>, to avoid blocking the initial render. #}
  {% include "webpack/js.njk" %}
{% endblock %}

{% block footer %}
  {% if "/" !== currentUrl and hideContactUs === undefined %}
    <div class="govuk-width-container">
      <details class="govuk-details" data-module="govuk-details">
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">
            {{ contactUsTitle }}
          </span>
        </summary>
        <div class="govuk-details__text">
          {{ contactUsForHelp|safe }}
        </div>
      </details>
    </div>
  {% endif %}

  {{ govukFooter({
  meta: {
    items: [
      {
          href: "/guide",
          text: guide
      },
      {
          href: "/terms-and-conditions",
          text: termsAndConditions
      },
      {
          href: "/cookies",
          text: cookiePolicy
      },
      {
          href: "/contact-us",
          text: contact
      }
    ]
  }
}) }}
{% endblock %}